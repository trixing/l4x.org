<html>
<head>
  <title>    | Jan's Home</title>
  <link rel="stylesheet" href="//l4x.org/l4x.css" type="text/css" media="screen" />
  <meta name="description" content="l4x.org - Jan Dittmer's Homepage" />
  <meta name="keywords" lang="de" content="elektronik, linux, Jan Dittmer, Jan, Dittmer, software, programmierung, blog, css, html, stylesheet, firefox,ipv6ident, ipv6, ip query firefox, ohg99, otto-hahn gymnasium, atmel, avr" />
  <meta name="ICBM" content="53.5467, 9.9783"/>
  <meta name="DC.title" content="l4x.org - Jan Dittmer's Homepage"/>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  </style>
</head>
<body>
<div id="header">
<div class="logo">
<span style="">l</span>
<span style="color:#ffe450;">4</span>
<span style="color:#000000;">x</span>
<span style="">.</span>
<span style="">o</span>
<span style="">r</span>
<span style="">g</span>
</div>

<div id="alpha">
	alpha playground
</div>

<div id="userinfo">
        &nbsp;
</div>

</div> <!-- header -->

<div id="mainnav">
<ul class="hori">
<!-- internal links -->
<li><a href="https://l4x.org">Home</a></li>
<li><a href="https://l4x.org/projects">Projects</a></li>
<!-- external links -->
<!-- broken
<li><a href="http://home.l4x.org/pics/">Pics</a></li>
-->
<li><a href="https://dns.l4x.org">dns.</a></li>
<li><a href="https://git.l4x.org">git.</a></li>
<li><a href="https://l4x.org/k/">Kernel-Tests</a></li>
<li><a href="https://www.trixing.de">Trixing</a></li>
<li><a href="https://l4x.org/imprint.html">Imprint</a></li>
</ul>


</div>  <!-- mainnav end -->

<div id="content">

<p>  </p>

<h2>Sun, 02 Feb 2014</h2>
<h3><a name="libvirt_openswan">How to securely bridge multiple libvirt networks using openswan
</a></h3>
<div class="blosxomStory">
<p>I own multiple root servers distributed in different data centers across
the world.  Each server runs libvirt and serves multiple VMs in private
subnets.  The goal of this exercise is to have the virtual machines
be able to securely talk to each other.  The default configuration for
libvirt enables NAT from a private network (192.168.122.0/24) to the Internet.</p>
<p>This post describes step-by-step how to establish secure tunnels between
three hosts (called b0, c0 and d0 respectively) but could very well be
extended further.  It enables hosting root servers in multiple heterogeneous
data centers and not worry about traffic between VMs.  They will be able to communicate with each other securely, just
like being on one single trusted router.</p>
<p>To establish the secure connection openswan is used
and the following instructions assume and are tested with Debian/wheezy.
Openswan as of writing this is at version 2.6.37-3 and libvirt is at 0.9.12-11.  No further packages
should be necessary (<tt class="docutils literal"><span class="pre">apt-get</span> install openswan <span class="pre">libvirt-bin</span></tt>).</p>
<p>First of all different subnets need to be assigned to each host.  For this
use <tt class="docutils literal">virsh <span class="pre">net-edit</span> default</tt> and change any occurrence of 192.168.122 by
a unique number.  The following is my own configuration used for the further examples:</p>
<pre class="literal-block">
Host  Public-IP  Subnet
----  ---------  ----------------
b0    10.2.2.2   192.168.122.0/24
c0    10.3.3.3   192.168.123.0/24
d0    10.4.4.4   192.168.124.0/24
</pre>
<p>Next restart <tt class="docutils literal">libvirt</tt> and verify using <tt class="docutils literal">ifconfig</tt>/<tt class="docutils literal">ip</tt> that the configuration has been
applied.  If any VM had a static IP address assigned it might need to be changed.</p>
<p>In the next step ipsec needs to be configured on each host.  Open <tt class="docutils literal">/etc/ipsec.conf</tt> in your
favorite editor
and add the following lines for each pair of hosts needing to directly communicate
with each other:</p>
<pre class="literal-block">
conn b0-to-c0
 authby=secret
 auto=start
 type=tunnel
 left=10.2.2.2
 leftid=10.2.2.2
 leftsubnet=192.168.122.0/24
 right=10.3.3.3
 rightid=10.3.3.3
 rightsubnet=192.168.123.0/24

conn b0-to-d0
 ...
 left=10.2.2.2
 leftsubnet=192.168.122.0/24
 ...
 right=10.4.4.4
 rightsubnet=192.168.124.0/24
 ...

conn c0-to-d0
 ...
 left=10.3.3.3
 leftsubnet=192.168.123.0/24
 ...
 right=10.4.4.4
 rightsubnet=192.168.124.0/24
 ...
</pre>
<p>The same file can be used for every host because non-existing interfaces will just
be ignored.  The left/right designation is arbitrary.</p>
<p>If multiple gateways exist on the host, the following might be useful (in addition to a <tt class="docutils literal">listen 10.2.2.2</tt> in the <tt class="docutils literal">config setup</tt> section):</p>
<pre class="literal-block">
leftnexthop=10.2.2.4
</pre>
<p>Next up configure authentication tokens between the hosts.  It is recommended to use host keys for
the connection, but for the sake of simplicity this uses the same
preshared key between all hosts (DO NOT DO THIS IN PRODUCTION).
Edit <tt class="docutils literal">/etc/ipsec.secrets</tt> and add:</p>
<pre class="literal-block">
10.2.2.2 %any: &quot;s3cr3t&quot;
10.3.3.3 %any: &quot;s3cr3t&quot;
10.4.4.4 %any: &quot;s3cr3t&quot;
</pre>
<p>Restart ipsec (<tt class="docutils literal">/etc/init.d/ipsec restart</tt>) on both ends.  Execute
<tt class="docutils literal">ipsec auto <span class="pre">--up</span> <span class="pre">b0-to-c0</span></tt> on each side and use <tt class="docutils literal">ipsec look</tt> and
<tt class="docutils literal">/var/log/daemon.log</tt> to verify that the tunnel comes up.</p>
<p>In theory it should be possible to ping both ends of the tunnel.  But
libvirt installs a pesky NAT rule by default to circumvent this execute
the following (can go into <tt class="docutils literal">/etc/rc.local</tt>):</p>
<pre class="literal-block">
iptables -I POSTROUTING 1 -d 192.168.0.0/16 -j RETURN  -t nat
</pre>
<p>This effectively disables the NAT rules for the whole private subnet
starting with 192.168.  Now try:</p>
<pre class="literal-block">
ping -I 192.168.123.1 192.168.122.1
</pre>
<p>If it does not work see above how
to verify that the tunnel came up.  If this is inconclusive
<tt class="docutils literal">tcpdump 'udp port 500'</tt> and on port 4500 should show in- and outgoing
packets.  Verify that all IP addresses are correct and no other firewall
rules are blocking communication on these ports.</p>
<p>It is necessary to specify <tt class="docutils literal"><span class="pre">-I</span> 192.168.123.1</tt> for ping because ipsec
doesn't install a default route for the network connection (different protocol
layer).  Thus execute a final:</p>
<pre class="literal-block">
route add -net 192.168.0.0/16 virbr0
</pre>
<p>on the host to route any traffic to and from the virtual machines correctly.  Now
<tt class="docutils literal">ping</tt> should work without the <tt class="docutils literal"><span class="pre">-I</span></tt> parameter.  Make it permanent by
adding it to <tt class="docutils literal">/etc/rc.local</tt>.</p>
<p>Communicating from within the VMs should now just work.  Verify that pinging
around different network produces the desired results.  If not verify that
IP forwarding is actually enabled.  <tt class="docutils literal">/etc/sysctl.conf</tt> should contain the
following line:</p>
<pre class="literal-block">
net.ipv4.ip_forward=1
</pre>
<p>As always with security, cross check this against other documentation and
verify using <tt class="docutils literal">tcpdump</tt> etc.  that the traffic is actually encrypted.</p>
<p></p>

<p class="posted">
  posted at 16:00 |
  path: <a href="https://l4x.org/vm" title="path">/vm</a> |
  <a href="https://l4x.org/vm/libvirt_openswan.html" title="How to securely bridge multiple libvirt networks using openswan
">permanent link to this entry</a>
</p>
</div>

</div>


<div id="sidebar">
<h2>Random Photo</h2>
<div class="sidebarbox">
<script><!-- //http://code.google.com/apis/gdata/docs/json.html
var es = [];
function r() {
	var idx = Math.floor(Math.random()*es.length);
	var m = es[idx]['media$group'];
	var i = document.getElementById("i");
	document.getElementById("t").innerHTML = m['media$description']['$t'];
	i.src = m['media$thumbnail'][0]['url'];
	setTimeout("r();",10*1000);
}
function j(p) {
	es = p['feed']['entry'];
	r();
}
function picasa() {
	var url='https://picasaweb.google.com/data/feed/base/user/jan.dittmer?kind=photo&thumbsize=160c&access=public&alt=json&callback=j';
	var s = document.createElement('script');
	s.src = url; document.body.appendChild(s);
}
window.onload = picasa;
//--></script>
<a href="http://picasaweb.google.com/jan.dittmer"> <img id="i"> </a>
<div id="t"></div>
</div>

<h2>Archives</h2>
<div class="sidebarbox">
	<li><a href="https://l4x.org/2014/Dec">Dec 2014</a></li>
<li><a href="https://l4x.org/2014/Jun">Jun 2014</a></li>
<li><a href="https://l4x.org/2014/Mar">Mar 2014</a></li>
<li><a href="https://l4x.org/2014/Feb">Feb 2014</a></li>
<li><a href="https://l4x.org/2013/Nov">Nov 2013</a></li>
<li><a href="https://l4x.org/2013/Oct">Oct 2013</a></li>
<li><a href="https://l4x.org/2013/Sep">Sep 2013</a></li>
<li><a href="https://l4x.org/2011/Jan">Jan 2011</a></li>
<li><a href="https://l4x.org/2010/Nov">Nov 2010</a></li>
<li><a href="https://l4x.org/2010/Oct">Oct 2010</a></li>
<li><a href="https://l4x.org/2010/Aug">Aug 2010</a></li>
<li><a href="https://l4x.org/2010/Feb">Feb 2010</a></li>
<li><a href="https://l4x.org/2010/Jan">Jan 2010</a></li>
<li><a href="https://l4x.org/2009/Sep">Sep 2009</a></li>
<li><a href="https://l4x.org/2008/Nov">Nov 2008</a></li>
<li><a href="https://l4x.org/2008/Jun">Jun 2008</a></li>
<li><a href="https://l4x.org/2008/Apr">Apr 2008</a></li>
<li><a href="https://l4x.org/2007/Sep">Sep 2007</a></li>
<li><a href="https://l4x.org/2007/Mar">Mar 2007</a></li>
<li><a href="https://l4x.org/2006/Nov">Nov 2006</a></li>
<li><a href="https://l4x.org/2006/Sep">Sep 2006</a></li>
<li><a href="https://l4x.org/2006/Aug">Aug 2006</a></li>
<li><a href="https://l4x.org/2006/Jun">Jun 2006</a></li>
<li><a href="https://l4x.org/2005/Jun">Jun 2005</a></li>
<li><a href="https://l4x.org/2005/May">May 2005</a></li>
<li><a href="https://l4x.org/2004/May">May 2004</a></li>
<li><a href="https://l4x.org/2003/Nov">Nov 2003</a></li>
</div>

<h2>Feed</h2>
<div class="sidebarbox">
<a title="RSS" href="https://l4x.org/index.rss20"> RSS </a> /
<a title="ATOM" href="https://l4x.org/index.atom"> ATOM  </a>
</div>

</div><!-- sidebar end -->


<div id="license">
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
</div>
</body>
</html>
