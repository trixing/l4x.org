<?xml version="1.0" encoding="utf-8"?>

<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
<title type="text">l4x.org</title>
<subtitle type="html"><![CDATA[
Home of Jan Dittmer
]]></subtitle>
<id>https://l4x.org/vm/libvirt_openswan.atom</id>
<link rel="alternate" type="text/html" href="https://l4x.org" />
<link rel="self" type="application/atom+xml" href="https://l4x.org/vm/libvirt_openswan.atom" />


<author>
<name>jdi et al.</name>
<uri>https://l4x.org/vm/libvirt_openswan.atom</uri>
<email>jdi@l4x.org</email>
</author>
<rights>Copyright 2008-2015 Jan Dittmer</rights>
<generator uri="http://pyblosxom.sourceforge.net/" version="1.5.3">
PyBlosxom http://pyblosxom.sourceforge.net/ 1.5.3
</generator>

<updated>2014-02-02T21:00:00Z</updated>
<!-- icon?  logo?  -->

<entry>
<title type="html">How to securely bridge multiple libvirt networks using openswan
</title>
<category term="" />
<id>https://l4x.org/2014/02/02/libvirt_openswan</id>
<updated>2014-02-02T21:00:00Z</updated>
<published>2014-02-02T21:00:00Z</published>
<link rel="alternate" type="text/html" href="https://l4x.org/vm/libvirt_openswan.html" />
<content type="html">&lt;p&gt;I own multiple root servers distributed in different data centers across
the world.  Each server runs libvirt and serves multiple VMs in private
subnets.  The goal of this exercise is to have the virtual machines
be able to securely talk to each other.  The default configuration for
libvirt enables NAT from a private network (192.168.122.0&#x2F;24) to the Internet.&lt;&#x2F;p&gt;
&lt;p&gt;This post describes step-by-step how to establish secure tunnels between
three hosts (called b0, c0 and d0 respectively) but could very well be
extended further.  It enables hosting root servers in multiple heterogeneous
data centers and not worry about traffic between VMs.  They will be able to communicate with each other securely, just
like being on one single trusted router.&lt;&#x2F;p&gt;
&lt;p&gt;To establish the secure connection openswan is used
and the following instructions assume and are tested with Debian&#x2F;wheezy.
Openswan as of writing this is at version 2.6.37-3 and libvirt is at 0.9.12-11.  No further packages
should be necessary (&lt;tt class=&quot;docutils literal&quot;&gt;&lt;span class=&quot;pre&quot;&gt;apt-get&lt;&#x2F;span&gt; install openswan &lt;span class=&quot;pre&quot;&gt;libvirt-bin&lt;&#x2F;span&gt;&lt;&#x2F;tt&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;First of all different subnets need to be assigned to each host.  For this
use &lt;tt class=&quot;docutils literal&quot;&gt;virsh &lt;span class=&quot;pre&quot;&gt;net-edit&lt;&#x2F;span&gt; default&lt;&#x2F;tt&gt; and change any occurrence of 192.168.122 by
a unique number.  The following is my own configuration used for the further examples:&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
Host  Public-IP  Subnet
----  ---------  ----------------
b0    10.2.2.2   192.168.122.0&#x2F;24
c0    10.3.3.3   192.168.123.0&#x2F;24
d0    10.4.4.4   192.168.124.0&#x2F;24
&lt;&#x2F;pre&gt;
&lt;p&gt;Next restart &lt;tt class=&quot;docutils literal&quot;&gt;libvirt&lt;&#x2F;tt&gt; and verify using &lt;tt class=&quot;docutils literal&quot;&gt;ifconfig&lt;&#x2F;tt&gt;&#x2F;&lt;tt class=&quot;docutils literal&quot;&gt;ip&lt;&#x2F;tt&gt; that the configuration has been
applied.  If any VM had a static IP address assigned it might need to be changed.&lt;&#x2F;p&gt;
&lt;p&gt;In the next step ipsec needs to be configured on each host.  Open &lt;tt class=&quot;docutils literal&quot;&gt;&#x2F;etc&#x2F;ipsec.conf&lt;&#x2F;tt&gt; in your
favorite editor
and add the following lines for each pair of hosts needing to directly communicate
with each other:&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
conn b0-to-c0
 authby=secret
 auto=start
 type=tunnel
 left=10.2.2.2
 leftid=10.2.2.2
 leftsubnet=192.168.122.0&#x2F;24
 right=10.3.3.3
 rightid=10.3.3.3
 rightsubnet=192.168.123.0&#x2F;24

conn b0-to-d0
 ...
 left=10.2.2.2
 leftsubnet=192.168.122.0&#x2F;24
 ...
 right=10.4.4.4
 rightsubnet=192.168.124.0&#x2F;24
 ...

conn c0-to-d0
 ...
 left=10.3.3.3
 leftsubnet=192.168.123.0&#x2F;24
 ...
 right=10.4.4.4
 rightsubnet=192.168.124.0&#x2F;24
 ...
&lt;&#x2F;pre&gt;
&lt;p&gt;The same file can be used for every host because non-existing interfaces will just
be ignored.  The left&#x2F;right designation is arbitrary.&lt;&#x2F;p&gt;
&lt;p&gt;If multiple gateways exist on the host, the following might be useful (in addition to a &lt;tt class=&quot;docutils literal&quot;&gt;listen 10.2.2.2&lt;&#x2F;tt&gt; in the &lt;tt class=&quot;docutils literal&quot;&gt;config setup&lt;&#x2F;tt&gt; section):&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
leftnexthop=10.2.2.4
&lt;&#x2F;pre&gt;
&lt;p&gt;Next up configure authentication tokens between the hosts.  It is recommended to use host keys for
the connection, but for the sake of simplicity this uses the same
preshared key between all hosts (DO NOT DO THIS IN PRODUCTION).
Edit &lt;tt class=&quot;docutils literal&quot;&gt;&#x2F;etc&#x2F;ipsec.secrets&lt;&#x2F;tt&gt; and add:&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
10.2.2.2 %any: &amp;quot;s3cr3t&amp;quot;
10.3.3.3 %any: &amp;quot;s3cr3t&amp;quot;
10.4.4.4 %any: &amp;quot;s3cr3t&amp;quot;
&lt;&#x2F;pre&gt;
&lt;p&gt;Restart ipsec (&lt;tt class=&quot;docutils literal&quot;&gt;&#x2F;etc&#x2F;init.d&#x2F;ipsec restart&lt;&#x2F;tt&gt;) on both ends.  Execute
&lt;tt class=&quot;docutils literal&quot;&gt;ipsec auto &lt;span class=&quot;pre&quot;&gt;--up&lt;&#x2F;span&gt; &lt;span class=&quot;pre&quot;&gt;b0-to-c0&lt;&#x2F;span&gt;&lt;&#x2F;tt&gt; on each side and use &lt;tt class=&quot;docutils literal&quot;&gt;ipsec look&lt;&#x2F;tt&gt; and
&lt;tt class=&quot;docutils literal&quot;&gt;&#x2F;var&#x2F;log&#x2F;daemon.log&lt;&#x2F;tt&gt; to verify that the tunnel comes up.&lt;&#x2F;p&gt;
&lt;p&gt;In theory it should be possible to ping both ends of the tunnel.  But
libvirt installs a pesky NAT rule by default to circumvent this execute
the following (can go into &lt;tt class=&quot;docutils literal&quot;&gt;&#x2F;etc&#x2F;rc.local&lt;&#x2F;tt&gt;):&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
iptables -I POSTROUTING 1 -d 192.168.0.0&#x2F;16 -j RETURN  -t nat
&lt;&#x2F;pre&gt;
&lt;p&gt;This effectively disables the NAT rules for the whole private subnet
starting with 192.168.  Now try:&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
ping -I 192.168.123.1 192.168.122.1
&lt;&#x2F;pre&gt;
&lt;p&gt;If it does not work see above how
to verify that the tunnel came up.  If this is inconclusive
&lt;tt class=&quot;docutils literal&quot;&gt;tcpdump &#x27;udp port 500&#x27;&lt;&#x2F;tt&gt; and on port 4500 should show in- and outgoing
packets.  Verify that all IP addresses are correct and no other firewall
rules are blocking communication on these ports.&lt;&#x2F;p&gt;
&lt;p&gt;It is necessary to specify &lt;tt class=&quot;docutils literal&quot;&gt;&lt;span class=&quot;pre&quot;&gt;-I&lt;&#x2F;span&gt; 192.168.123.1&lt;&#x2F;tt&gt; for ping because ipsec
doesn&#x27;t install a default route for the network connection (different protocol
layer).  Thus execute a final:&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
route add -net 192.168.0.0&#x2F;16 virbr0
&lt;&#x2F;pre&gt;
&lt;p&gt;on the host to route any traffic to and from the virtual machines correctly.  Now
&lt;tt class=&quot;docutils literal&quot;&gt;ping&lt;&#x2F;tt&gt; should work without the &lt;tt class=&quot;docutils literal&quot;&gt;&lt;span class=&quot;pre&quot;&gt;-I&lt;&#x2F;span&gt;&lt;&#x2F;tt&gt; parameter.  Make it permanent by
adding it to &lt;tt class=&quot;docutils literal&quot;&gt;&#x2F;etc&#x2F;rc.local&lt;&#x2F;tt&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Communicating from within the VMs should now just work.  Verify that pinging
around different network produces the desired results.  If not verify that
IP forwarding is actually enabled.  &lt;tt class=&quot;docutils literal&quot;&gt;&#x2F;etc&#x2F;sysctl.conf&lt;&#x2F;tt&gt; should contain the
following line:&lt;&#x2F;p&gt;
&lt;pre class=&quot;literal-block&quot;&gt;
net.ipv4.ip_forward=1
&lt;&#x2F;pre&gt;
&lt;p&gt;As always with security, cross check this against other documentation and
verify using &lt;tt class=&quot;docutils literal&quot;&gt;tcpdump&lt;&#x2F;tt&gt; etc.  that the traffic is actually encrypted.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;&#x2F;p&gt;
</content>
</entry>
</feed>
